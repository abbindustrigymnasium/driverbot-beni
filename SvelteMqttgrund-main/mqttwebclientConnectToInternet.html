<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Gamepad Joystick Control</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
</head>
<body>
    <div class="wrapper">
        <h1>Gamepad Joystick Control</h1>
        <div id="gamepadStatus">Gamepad Status: Disconnected</div>
        <div id="brokerdata"></div>
        <div id="joystickValue">Joystick Value: </div>

        <div id="log"></div> <!-- Added log container -->
    </div>

    <script>
        let gamepad, client;

        window.addEventListener("gamepadconnected", e => {
            console.log(`Gamepad connected at index ${e.gamepad.index}: ${e.gamepad.id}. ${e.gamepad.buttons.length} buttons, ${e.gamepad.axes.length} axes.`);
            gamepad = e.gamepad;
            document.getElementById("gamepadStatus").textContent = "Gamepad Status: Connected";
            client = new Paho.MQTT.Client("maqiatto.com", 8883, "clientID_" + parseInt(Math.random() * 100));
            client.onConnectionLost = onConnectionLost;
            client.connect({ userName: "benijuste.ngabire@hitachigymnasiet.se", password: "brok", onSuccess: onConnect, onFailure: onFail });
        });

        window.addEventListener("gamepaddisconnected", e => {
            console.log(`Gamepad disconnected from index ${e.gamepad.index}: ${e.gamepad.id}`);
            gamepad = null;
            document.getElementById("gamepadStatus").textContent = "Gamepad Status: Disconnected";
            document.getElementById("gamepadData").textContent = "Gamepad Data: N/A";
        });

        function logMessage(message) {
            document.getElementById("log").innerHTML += `<div>${message}</div>`;
        }

        function update() {
            // Get the latest gamepad object
            const gamepads = navigator.getGamepads();
            gamepad = gamepads[0]; // Assuming only one gamepad is connected
            
            if (gamepad) {
                let newValue = Math.round(gamepad.axes[0] * 90 + 90);
        
                // Check if the value falls within the interval 80-100
                if (newValue >= 80 && newValue <= 100) {
                    newValue = 90; // Set the value to 90
                }
        
                document.getElementById("joystickValue").textContent = `Joystick Value: ${newValue}`;
                sendValueToBroker(newValue);
            }
            requestAnimationFrame(update);
        }
        

        function sendValueToBroker(value) {
            if (client && client.isConnected()) {
                let message = new Paho.MQTT.Message(value.toString());
                message.destinationName = "benijuste.ngabire@hitachigymnasiet.se/gamepad";
                client.send(message);
                document.getElementById("brokerdata").innerHTML = `Joystick value sent to MQTT broker: ${value}`
               
            } else {
                logMessage("Error: MQTT client is not connected");
            }
        }
        

        function onConnect() {
            console.log("Connected to MQTT broker");
            logMessage("Connected to MQTT broker");
            requestAnimationFrame(update);
        }

        function onFail() {
            console.error("Failed to connect to MQTT broker");
            logMessage("Failed to connect to MQTT broker");
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.error("Connection lost:", responseObject.errorMessage);
                logMessage(`Connection lost: ${responseObject.errorMessage}`);
            }
        }
    </script>
</body>
</html>
